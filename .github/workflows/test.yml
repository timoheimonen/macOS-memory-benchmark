name: Build and Test

on:
  pull_request:
    branches: [ main, development ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test on Apple Silicon
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: System Information
      run: |
        echo "Runner information:"
        uname -m
        uname -a
        sysctl -n machdep.cpu.brand_string
        sysctl -n hw.perflevel0.physicalcpu
        sysctl -n hw.perflevel1.physicalcpu
        echo "Xcode version:"
        xcodebuild -version || true
        echo "Clang version:"
        clang++ --version

    - name: Install Google Test
      run: |
        brew install googletest
        echo "Google Test installed at:"
        brew --prefix googletest

    - name: Build project
      run: make

    - name: Run all tests
      run: make test-all

    - name: Clean build artifacts
      if: always()
      run: make clean
